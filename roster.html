<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Roster - Get Stuff Done Committee</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  
</head>
<body>
  <header>
    <div class="wrap header-content">
      <img src="GSD_logo.png" alt="Get Stuff Done Logo" class="logo">
      <div class="header-text">
        <h1>Get Stuff Done Committee</h1>
        <div class="sub">Roster</div>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top: 24px;">

  <div style="margin-top: 20px;">
    <a href="#" id="openSubscribe" class="btn">Subscribe (or subscribe a friend)</a>
    <a href="#" id="openUnsubscribe" class="btn">Unsubscribe</a>
  </div>

    <!-- Subscription Modal -->
    <div id="subscribeModal" class="hide">
      <div style="background:white; padding:24px; border-radius:16px; max-width:400px; width:90%;">
        <h2>Subscribe to Roster</h2>
        <form id="subscribeForm" style="display:grid; gap:12px;">
          <input type="text" name="firstName" placeholder="First Name" required>
          <input type="text" name="lastName" placeholder="Last Name" required>
          <input type="email" name="email" placeholder="Email" required>
          <input type="tel" name="phone" placeholder="Phone">
          <button type="submit" class="btn primary">Submit</button>
          <button type="button" id="closeModal" class="btn" style="background:#eee;">Cancel</button>
        </form>
        <div id="subscribeNotice" style="margin-top:10px; font-size:14px;"></div>
      </div>
    </div>

    <!-- Unsubscribe Modal -->
    <div id="unsubscribeModal" class="hide">
      <div style="background:white; padding:24px; border-radius:16px; max-width:400px; width:90%;">
        <h2>Unsubscribe from Roster</h2>
        <form id="unsubscribeForm" style="display:grid; gap:12px;">
          <select name="memberId" id="unsubscribeSelect" required>
            <option value="">Select a member</option>
          </select>
          <button type="submit" class="btn primary">Unsubscribe</button>
          <button type="button" id="closeUnsubModal" class="btn" style="background:#eee;">Cancel</button>
        </form>
        <div id="unsubscribeNotice" style="margin-top:10px; font-size:14px;"></div>
      </div>
    </div>
      
    <!-- Roster Container -->
    <div id="rosterContainer" style="margin-top: 24px;">
      <ul id="rosterList"></ul>
    </div>

</main>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw4T5tw1oO56KLYyIrkyyrAC-AUdht_mN2jwSSqIptd13he7VrcnYNnJ1E_veZziToO/exec';
    const ROSTER_URL = 'https://script.google.com/macros/s/AKfycbw4T5tw1oO56KLYyIrkyyrAC-AUdht_mN2jwSSqIptd13he7VrcnYNnJ1E_veZziToO/exec?type=roster';  

    let cachedRoster = null;
 
    //Subscribe
    document.getElementById('openSubscribe').addEventListener('click', e => {
      e.preventDefault();
      document.getElementById('subscribeModal').classList.remove('hide');
    });
  
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('subscribeModal').classList.add('hide');
      document.getElementById('subscribeNotice').textContent = '';
      document.getElementById('subscribeForm').reset();
      fetchRoster();  
    });
  
    document.getElementById('subscribeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = {
        action: 'add_roster', // weâ€™ll handle this in Apps Script
        firstName: form.firstName.value.trim(),
        lastName: form.lastName.value.trim(),
        email: form.email.value.trim(),
        phone: form.phone.value.trim(),
        status: 'Active'
      };
  
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        const result = await res.json();
  
        if (result.ok) {
          document.getElementById('subscribeNotice').textContent = 'Successfully added!';
          form.reset();
          fetchRoster(); // refresh roster list
        } else {
          document.getElementById('subscribeNotice').textContent = 'Error: ' + (result.error || 'unknown');
        }
  
      } catch (err) {
        console.error(err);
        document.getElementById('subscribeNotice').textContent = 'Error submitting form.';
      }
    });

    // Helper: populate unsubscrive dropdown
    function populateUnsubscribeDropdown(roster, select) {
      const sorted = [...roster].sort((a, b) => {
        const lastA = (a['Last Name'] || '').toLowerCase();
        const lastB = (b['Last Name'] || '').toLowerCase();
        return lastA.localeCompare(lastB);
      });
    
      sorted.forEach(member => {
        const option = document.createElement('option');
        option.value = member.email || `${member['First Name']}-${member['Last Name']}`;
        option.textContent = `${member['First Name']} ${member['Last Name']}`;
        select.appendChild(option);
      });
    }

    // Unsubscribe
    document.getElementById('openUnsubscribe').addEventListener('click', e => {
      e.preventDefault();
      const unsubscribeModal = document.getElementById('unsubscribeModal');
      const select = document.getElementById('unsubscribeSelect');
      select.innerHTML = '<option value="">Select a member</option>';
    
      if (cachedRoster) {
        populateUnsubscribeDropdown(cachedRoster, select);
        unsubscribeModal.classList.remove('hide');
      } else {
        fetch(ROSTER_URL)
          .then(res => res.json())
          .then(data => {
            if (!data.ok || !data.roster) return;
            cachedRoster = data.roster;
            populateUnsubscribeDropdown(cachedRoster, select);
            unsubscribeModal.classList.remove('hide');
          });
      }
    });
    
      document.getElementById('closeUnsubModal').addEventListener('click', () => {
      document.getElementById('unsubscribeModal').classList.add('hide');
      document.getElementById('unsubscribeNotice').textContent = '';
    });
    
    document.getElementById('unsubscribeForm').addEventListener('submit', async e => {
      e.preventDefault();
      const select = document.getElementById('unsubscribeSelect');
      const memberIndex = select.value;
      if (memberIndex === '') return;
    
      try {
        const rosterRes = await fetch(ROSTER_URL);
        const rosterData = await rosterRes.json();
        const selectedEmail = select.value;
        const member = rosterData.roster.find(m => (m.email || `${m['First Name']}-${m['Last Name']}`) === selectedEmail);
    
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'update_roster',
            firstName: member['First Name'],
            lastName: member['Last Name'],
            email: member.email || '',
            phone: member.phone || '',
            status: 'Not Active'
          })
        });
        const result = await res.json();
    
        if (result.ok) {
          document.getElementById('unsubscribeNotice').textContent = 'Successfully unsubscribed!';
          fetchRoster(); // refresh roster list
          document.getElementById('unsubscribeModal').classList.add('hide');
        } else {
          document.getElementById('unsubscribeNotice').textContent = 'Error: ' + (result.error || 'unknown');
        }
      } catch (err) {
        console.error(err);
        document.getElementById('unsubscribeNotice').textContent = 'Error unsubscribing.';
      }
    });

  
  // Generate Roster
  async function fetchRoster() {
    try {
      const res = await fetch(ROSTER_URL);
      const data = await res.json();

      const rosterList = document.getElementById('rosterList');
      rosterList.innerHTML = '';

      if (!data.ok || !data.roster) {
        rosterList.innerHTML = '<li style="color:red;">Failed to load roster.</li>';
        return;
      }
      cachedRoster = data.roster;
      const sortedRoster = [...data.roster].sort((a, b) => {
      const lastA = (a['Last Name'] || '').toLowerCase();
      const lastB = (b['Last Name'] || '').toLowerCase();
      return lastA.localeCompare(lastB);
    });

      sortedRoster.forEach(member => {
      const firstName = member['First Name'] || '';
      const lastName = member['Last Name'] || '';
      const status = member['status'] || 'Active';

      const li = document.createElement('li');
      li.textContent = `${firstName} ${lastName}`;
      if (status.toLowerCase() === 'not active') li.classList.add('not-active');

      rosterList.appendChild(li);
      });

    } catch (err) {
      console.error(err);
      document.getElementById('rosterList').innerHTML = '<li style="color:red;">Error fetching roster.</li>';
    }
  }

  fetchRoster();
</script>

    <footer>
    <div class="wrap">
      <p>&copy; Get Stuff Done Committee</p>
    </div>
  </footer>
</body>
</html>
