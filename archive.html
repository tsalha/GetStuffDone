<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Get Stuff Done — St. Chris Dads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="wrap header-content">
      <img src="GSD_logo.png" alt="Get Stuff Done Logo" class="logo">
      <div class="header-text">
        <h1>Get Stuff Done Committee</h1>
        <div class="sub">Event Archive</div>
        <div style="margin-top: 16px;">
          <a href="https://www.scgetstuffdone.com/index.html" class="btn">Events</a>
          <a href="https://www.scgetstuffdone.com/roster.html" class="btn">Roster (click here to subscribe/unsubscribe)</a>
          <a href="https://www.scgetstuffdone.com/pictures.html" class="btn">GSD Pics</a>
        </div>
      </div>
    </div>
  </header>

  <div id="admin" class="adminbar hide">
    <div class="wrap">
      <strong>Admin</strong> — Add or edit events here.
      <form id="adminForm" style="display:grid;gap:8px;grid-template-columns:2fr 1fr 1fr 1fr 1fr;align-items:center;margin-top:8px">
        <input name="title" placeholder="Event title" required>
        <input name="date_iso" type="date" required>
        <input name="start_time" type="time">
        <input name="end_time" type="time">
        <input name="capacity" type="number" min="0" placeholder="Capacity" required>
        <input name="location" placeholder="Location" class="full">
        <input name="description" placeholder="Description (markdown ok)" class="full">
        <button class="btn primary" type="submit">Create event</button>
      </form>
    </div>
  </div>

  <main class="wrap">
    <div id="loading">Loading archived events, please wait…</div>
    <section id="events" style="display:none;"></section>
  </main>

  <template id="event-tpl">
    <article class="event">
      <h3></h3>
      <div class="capacity"></div>
      <div class="names" style="margin-top:4px"></div>
    </article>
  </template>

  <script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbw4T5tw1oO56KLYyIrkyyrAC-AUdht_mN2jwSSqIptd13he7VrcnYNnJ1E_veZziToO/exec'; 
const ADMIN_SECRET = 'STCHRIS';

const listEl = document.getElementById('events');
  const tpl = document.getElementById('event-tpl');

  // === UTILITY FUNCTIONS ===
  function fmtDate(d){
      const dt = (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d))
          ? new Date(d + 'T00:00:00')
          : new Date(d);
      if (isNaN(dt)) return 'Invalid date';
      return dt.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'});
  }

  function fmtTime(time24) {
      if (!time24) return ''; 
      const [hourStr, minute] = time24.split(':');
      let hour = parseInt(hourStr, 10);
      const ampm = hour >= 12 ? 'pm' : 'am';
      hour = hour % 12 || 12; 
      return `${hour}:${minute} ${ampm}`;
  }

  // === RENDER EVENTS ===
  function render(events){
      document.getElementById('loading').style.display = 'none';
      listEl.style.display = 'block';
      listEl.innerHTML = '';

      if(events.length === 0){
          listEl.innerHTML = '<p>No archived events yet.</p>';
          return;
      }

      events.forEach(ev => {
          const node = tpl.content.cloneNode(true);

          const start = ev.start_time ? fmtTime(ev.start_time) : '';
          const end = ev.end_time ? fmtTime(ev.end_time) : '';
          node.querySelector('h3').textContent = `${ev.title} — ${fmtDate(ev.date_iso)}${start ? ' @ ' + start : ''}${end ? ' to ' + end : ''}`;
          node.querySelector('.capacity').textContent = `${ev.confirmed.length}/${ev.capacity} signed up` + (ev.waitlisted.length ? ` • ${ev.waitlisted.length} on waitlist` : '');

          const names = node.querySelector('.names');
          ev.confirmed.forEach(s => { 
              const chip = document.createElement('span'); 
              chip.className = 'name'; 
              chip.textContent = s.name; 
              names.appendChild(chip); 
          });

          listEl.appendChild(node);
      });
  }

  // === LIVE REFRESH ===
  let initialized = false;
  let lastSnapshot = '';

  async function refresh() {
      try {
          const data = await fetch(API_BASE).then(r => r.json());
          if (!data || !data.ok) return;

          const snap = JSON.stringify(data.events);

          if (!initialized || snap !== lastSnapshot){
              render(data.events);
              initialized = true;
              lastSnapshot = snap;
          }
      } catch(e){
          console.error('Error fetching events:', e);
      }
  }

  refresh();
  setInterval(refresh, 3000);

  // === ADMIN TOGGLE ===
  const urlParams = new URLSearchParams(location.search);
  if(urlParams.get('admin') === ADMIN_SECRET){ 
      document.getElementById('admin').classList.remove('hide'); 
  }

  // Admin form submission (if you keep the form on this page)
  const adminForm = document.getElementById('adminForm');
  if(adminForm){
      adminForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const fd = new FormData(adminForm);
          const body = Object.fromEntries(fd.entries());
          body.action = 'create_event';
          body.admin_secret = ADMIN_SECRET;
          const res = await fetch(API_BASE, {method:'POST', body: JSON.stringify(body)}).then(r=>r.json());
          if(!res.ok){ alert(res.error||'Error'); return; }
          adminForm.reset();
          refresh();
      });
  }
</script>

</body>
</html>
