<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Get Stuff Done — St. Chris Dads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="wrap header-content">
      <img src="GSD_logo.png" alt="Get Stuff Done Logo" class="logo">
      <div class="header-text">
        <h1>Get Stuff Done Committee</h1>
        <div class="sub">Volunteer opportunities</div>
        <div style="margin-top: 16px;">
          <a href="https://www.scgetstuffdone.com/roster.html" class="btn">
            Roster (click here to subscribe/unsubscribe)
          </a>
        </div>
      </div>
    </div>
  </header>

  <div id="admin" class="adminbar hide">
    <div class="wrap">
      <strong>Admin</strong> — Add or edit events here.
      <form id="adminForm" style="display:grid;gap:8px;grid-template-columns:2fr 1fr 1fr 1fr 1fr;align-items:center;margin-top:8px">
        <input name="title" placeholder="Event title" required>
        <input name="date_iso" type="date" required>
        <input name="start_time" type="time">
        <input name="end_time" type="time">
        <input name="capacity" type="number" min="0" placeholder="Capacity" required>
        <input name="location" placeholder="Location" class="full">
        <input name="description" placeholder="Description (markdown ok)" class="full">
        <button class="btn primary" type="submit">Create event</button>
      </form>
    </div>
  </div>

  <main class="wrap">
    <section id="events"></section>
  </main>

  <template id="event-tpl">
    <article class="event">
      <h3></h3>
      <div class="capacity"></div>
      <div class="names"></div>
      <details style="margin-top:8px">
        <summary>Sign up</summary>
        <form class="signup">
          <input name="name" placeholder="Your name" required>
          <input name="email" type="email" placeholder="Email" required>
          <input name="phone" type="tel" placeholder="Phone" class="full">
          <div class="notice">Your name will appear publicly on this page. Email/phone are private.</div>
          <div class="notice">On submit, you’ll receive an email confirmation with a cancel link.</div>
          <button class="btn primary full">Sign up</button>
        </form>
        <div class="token-area hide notice"></div>
      </details>
      <div style="margin-top:8px">
        <button class="btn ics">Add to Calendar</button>
      </div>
    </article>
  </template>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbw4T5tw1oO56KLYyIrkyyrAC-AUdht_mN2jwSSqIptd13he7VrcnYNnJ1E_veZziToO/exec'; // e.g., https://script.google.com/macros/s/AKfycb.../exec
    const ADMIN_SECRET = 'STCHRIS'; // also set in Apps Script script properties

    // Admin toggle via ?admin=SECRET
    const urlParams = new URLSearchParams(location.search);
    if(urlParams.get('admin') === ADMIN_SECRET){ document.getElementById('admin').classList.remove('hide'); }

    async function apiGet(){
      const r = await fetch(API_BASE);
      return r.json();
    }
    async function apiPost(body){
      const r = await fetch(API_BASE, {method:'POST', body: JSON.stringify(body)});
      return r.json();
    }

    const listEl = document.getElementById('events');
    const tpl = document.getElementById('event-tpl');

    function fmtDate(d){
      const dt = (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d))
        ? new Date(d + 'T00:00:00')
        : new Date(d);
      
      if (isNaN(dt)) return 'Invalid date';
      return dt.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'});
    }

    function fmtTime(time24) {
      if (!time24) return ''; 
      const [hourStr, minute] = time24.split(':');
      let hour = parseInt(hourStr, 10);
      const ampm = hour >= 12 ? 'pm' : 'am';
      hour = hour % 12 || 12; 
      return `${hour}:${minute} ${ampm}`;
    }

    function render(events){
      listEl.innerHTML = '';
      events.forEach(ev=>{
        const node = tpl.content.cloneNode(true);
        const start = ev.start_time ? fmtTime(ev.start_time) : '';
        const end = ev.end_time ? fmtTime(ev.end_time) : '';

        node.querySelector('h3').textContent = `${ev.title} — ${fmtDate(ev.date_iso)}${start ? ' @ ' + start : ''}${end ? ' to ' + end : ''}`;

        //node.querySelector('h3').textContent = `${ev.title} — ${fmtDate(ev.date_iso)}${ev.start_time? ' @ ' + ev.start_time: ' to '} to ${ev.end_time}`;
        node.querySelector('.capacity').textContent = `${ev.confirmed.length}/${ev.capacity} signed up` + (ev.waitlisted.length? ` • ${ev.waitlisted.length} on waitlist`: '');

        const names = node.querySelector('.names');
        ev.confirmed.forEach(s=>{ const chip = document.createElement('span'); chip.className='name'; chip.textContent=s.name; names.appendChild(chip); });

        const form = node.querySelector('form.signup');
        const tokenArea = node.querySelector('.token-area');
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const fd = new FormData(form);
          const payload = Object.fromEntries(fd.entries());
          payload.action = 'signup';
          payload.event_id = ev.id;
          const res = await apiPost(payload);
          if(!res.ok){ alert(res.error||'Error'); return; }
          tokenArea.classList.remove('hide');
          tokenArea.innerHTML = `\n<strong>Saved.</strong> Status: ${res.status}.<br>\nCopy your private link to edit/cancel: <code>${location.origin}${location.pathname}?edit=${res.id}&token=${res.token}</code>\n`;
          form.reset();
          // Immediate UI update
          if(res.status==='CONFIRMED'){
            const chip = document.createElement('span'); chip.className='name'; chip.textContent=payload.name; names.appendChild(chip);
          }
        });
     
        // ICS download
        node.querySelector('.ics').addEventListener('click', ()=>{
          const ics = generateICS(ev);
          const blob = new Blob([ics], {type:'text/calendar'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${ev.title}.ics`; a.click();
        });
      
        listEl.appendChild(node);
      });
    }

    // Poll for live updates every 12s (can tune down)
    async function refresh(){
      try{ const data = await apiGet(); if(data.ok) render(data.events); }catch(e){}
    }
    refresh();
    setInterval(refresh, 3000);

    //1:05 ADD
    let initialized = false;
    let lastSnapshot = '';

    async function refresh() {
      try {
          const data = await apiGet();
          if (!data || !data.ok) return;
          const snap = JSON.stringify(data.events||[]);
          if (!initialized || snap !== lastSnapshot){
              render(data.events);
              initialized = true;
              lastSnapshot = snap;
            }
      } catch(e){}
    }
    //refresh();

    // Admin create event
    const adminForm = document.getElementById('adminForm');
    if(adminForm){
      adminForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(adminForm);
        const body = Object.fromEntries(fd.entries());
        body.action = 'create_event';
        body.admin_secret = ADMIN_SECRET;
        const res = await apiPost(body);
        if(!res.ok){ alert(res.error||'Error'); return; }
        adminForm.reset();
        refresh();
      });
    }

    // Edit/cancel flow using token in URL
    const editId = urlParams.get('edit');
    const token  = urlParams.get('token');
    if(editId && token){
      const cancel = confirm('Do you want to cancel your sign-up?');
      if(cancel){
        apiPost({action:'cancel', signup_id: editId, token})
          .then(()=>refresh());
      }
    }

    function generateICS(ev){
      // Simple ICS for all-day or time-bound event
      const dt = ev.date_iso.replace(/-/g,'');
      const start = (ev.start_time? dt + 'T' + ev.start_time.replace(':','') + '00' : dt);
      const end = (ev.end_time? dt + 'T' + ev.end_time.replace(':','') + '00' : dt);
      return `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Get Stuff Done//EN\nBEGIN:VEVENT\nUID:${crypto.randomUUID()}\nDTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z\nDTSTART:${start}\n${ev.end_time? 'DTEND:'+end+'\n':''}SUMMARY:${escapeICS(ev.title)}\nDESCRIPTION:${escapeICS(ev.description||'')}\nLOCATION:${escapeICS(ev.location||'')}\nEND:VEVENT\nEND:VCALENDAR`;
    }
    function escapeICS(s){return (s||'').replace(/[\\,;\n]/g, m=>({"\\":"\\\\", ",":"\\,",";":"\\;","\n":"\\n"}[m]));}
  </script>
</body>
</html>
